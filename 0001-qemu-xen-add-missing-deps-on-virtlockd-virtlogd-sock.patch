From 88c5b9f827779ae6fe5a6f08100a4b6184492a1c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Daniel=20P=2E=20Berrang=C3=A9?= <berrange@redhat.com>
Date: Tue, 31 Aug 2021 10:59:39 +0100
Subject: [PATCH] qemu, xen: add missing deps on virtlockd/virtlogd sockets
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The QEMU driver uses both virtlogd and virtlockd, while the Xen driver
uses virtlockd. The libvirtd.service unit contains deps on the socket
units for these services, but these deps were missed in the modular
daemons. As a result the virtlockd/virtlogd sockets are not started
when the virtqemud/virtxend daemons are started.

Reviewed-by: Jiri Denemark <jdenemar@redhat.com>
Signed-off-by: Daniel P. Berrang√© <berrange@redhat.com>
---
 src/libxl/virtxend.service.in | 2 ++
 src/qemu/virtqemud.service.in | 4 ++++
 2 files changed, 6 insertions(+)

diff --git a/src/libxl/virtxend.service.in b/src/libxl/virtxend.service.in
index a863917467..19b19ce3e6 100644
--- a/src/libxl/virtxend.service.in
+++ b/src/libxl/virtxend.service.in
@@ -1,6 +1,7 @@
 [Unit]
 Description=Virtualization xen daemon
 Conflicts=libvirtd.service
+Requires=virtlockd.socket
 Requires=virtxend.socket
 Requires=virtxend-ro.socket
 Requires=virtxend-admin.socket
@@ -25,6 +26,7 @@ KillMode=process
 
 [Install]
 WantedBy=multi-user.target
+Also=virtlockd.socket
 Also=virtxend.socket
 Also=virtxend-ro.socket
 Also=virtxend-admin.socket
diff --git a/src/qemu/virtqemud.service.in b/src/qemu/virtqemud.service.in
index 8abc9d3a7f..20e1b43a6e 100644
--- a/src/qemu/virtqemud.service.in
+++ b/src/qemu/virtqemud.service.in
@@ -1,6 +1,8 @@
 [Unit]
 Description=Virtualization qemu daemon
 Conflicts=libvirtd.service
+Requires=virtlogd.socket
+Requires=virtlockd.socket
 Requires=virtqemud.socket
 Requires=virtqemud-ro.socket
 Requires=virtqemud-admin.socket
@@ -42,6 +44,8 @@ LimitMEMLOCK=64M
 
 [Install]
 WantedBy=multi-user.target
+Also=virtlogd.socket
+Also=virtlockd.socket
 Also=virtqemud.socket
 Also=virtqemud-ro.socket
 Also=virtqemud-admin.socket
-- 
2.31.1

